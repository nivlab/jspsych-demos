<!DOCTYPE html>
<html>
<head>
  <title>Audio Test</title>

  <!-- Load libraries -->
  <script src="../../lib/jspsych-7.2.1/jspsych.js"></script>

  <!-- Load jsPsych plug-ins -->
  <script src="./audio-test.js"></script>
  <script src="../../lib/jspsych-7.2.1/dist/plugin-preload.js"></script>
  <script src="../../lib/jspsych-7.2.1/dist/plugin-html-button-response.js"></script>

  <!-- Load CSS styles -->
  <link href="../../lib/jspsych-7.2.1/css/jspsych.css" rel="stylesheet" type="text/css"></link>
</head>
<body></body>
<script>

  // Display alert message on back/refresh.
  // https://developer.mozilla.org/en-US/docs/Web/API/WindowEventHandlers/onbeforeunload
  function verify_unload(e){
    e.preventDefault();
    (e || window.event).returnValue = null;
    return null;
  };
  window.addEventListener("beforeunload", verify_unload);

  // randomly sample audio file
  const stimuli = [
    './audio/audio1.mp3',
    './audio/audio2.mp3',
    './audio/audio3.mp3',
    './audio/audio4.mp3',
  ];
  const responses = ['tiger', 'shark', 'turtle', 'fish'];
  // init Psych
  var jsPsych = initJsPsych({
    show_progress_bar: true,
    use_webaudio:true,
    //override_safe_mode:true,
    on_finish: function() {

      // Remove requirement to verify redirect
      window.removeEventListener("beforeunload", verify_unload);

      // Add interactions to the data variable
      var interaction_data = jsPsych.data.getInteractionData();
      jsPsych.data.get().addToLast({interactions: interaction_data.json()});

      // Display jsPsych data in viewport.
      jsPsych.data.displayData();

    }
  });

  // define preload
  // automatically preload all stimuli files based on the timeline
  var preload = {
    type: jsPsychPreload,
    auto_preload: true,
    message: 'Loading sounds. This may take a moment depending on your internet connection.',
    // on_error: function(file) {
    //     console.log('Error: ',file);
    //   },
    //   on_success: function(file) {
    //     console.log('Loaded: ',file);
    //   }
  }
  //welocome
  var welcome = {
    type: jsPsychHtmlButtonResponse,
    choices:['Continue'],
    stimulus: "Welcome to the experiment.\
          In order to complete this experiment, you will need to have your\
          computer audio on. If you do not have computer audio,\
          you will not be able to complete this experiment.\
          <br><br>We will now test your audio. When you press the button below,\
          you will hear a word being spoken.<br><br>On the following screen,\
          we will ask you to tell us what word you heard.\
          This allows us to verify that your audio is working."
  };

  // get random id
  var idx = jsPsych.randomization.sampleWithoutReplacement([0,1,2,3],1);

  // define audio test
  var audio_test = {
    prompt:'Please type the word that you heard in the box below.<br>(HINT: it is an animal)',
    type: jsPsychAudioTest,
    stimulus: stimuli[idx],
    correct_response:responses[idx],
    loop_function: function(data){
    if(data.values()[1].response.button == 1){
      return true; // loop again!
    } else {
      return false; // continue
    }
  }
  };

  // Initialize timeline.
  var timeline = [];
  timeline = timeline.concat(preload);
  timeline = timeline.concat(welcome);
  timeline = timeline.concat(audio_test);


  jsPsych.run(timeline);

</script>
</html>
